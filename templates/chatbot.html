<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/chatbot.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <title>Chatbot</title>
</head>
<body>
    <div class="page">
        <button class="logout"><a href="/logout"><img src="static/Logout.png" alt="Logout"></a></button>
        <div class="hello">
            <h2>MUREC</h2>
            <h4>Feel the Music, Match the Mood!</h4>    
        </div>
        <div class="chatbubble">
            <h5>
                Hello, how are you feeling today?
            </h5>
            <h3 id="emotion-text" style="color:black; font-size: 12px; font-family: Arial, sans-serif; text-align: center; border: 2px; background-color: aliceblue;
            height: 27px; width: 200px; margin-left: 450px; border-radius: 15%; font-size: medium; color:#510202; opacity: 50%; padding: 15px; display:none;"></h3>
        </div> 
        <br>
        <br>
        <br>


        <div id="chat-container">
        </div>
        
        <div id="player-container" style="display:none; text-align: center;" class="NP">
            <h3>Now Playing:</h3>
            <iframe id="spotify-player" src="" width="300" height="80" frameborder="0" allowtransparency="false" allow="encrypted-media"></iframe>
        </div>
        <div class="input">
            <form id="audio-form" action="/home" method="POST" enctype="multipart/form-data">
                <button type="button" id="record-button"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="35" height="35" viewBox="0 0 256 256" xml:space="preserve">

                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 45 0 c -8.481 0 -15.382 6.9 -15.382 15.382 v 29.044 c 0 8.482 6.9 15.382 15.382 15.382 s 15.382 -6.9 15.382 -15.382 V 15.382 C 60.382 6.9 53.481 0 45 0 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                        <path d="M 69.245 38.312 c -1.104 0 -2 0.896 -2 2 v 6.505 c 0 12.266 -9.979 22.244 -22.245 22.244 s -22.245 -9.979 -22.245 -22.244 v -6.505 c 0 -1.104 -0.896 -2 -2 -2 s -2 0.896 -2 2 v 6.505 c 0 13.797 10.705 25.134 24.245 26.16 V 86 h -9.126 c -1.104 0 -2 0.896 -2 2 s 0.896 2 2 2 h 22.252 c 1.104 0 2 -0.896 2 -2 s -0.896 -2 -2 -2 H 47 V 72.978 c 13.54 -1.026 24.245 -12.363 24.245 -26.16 v -6.505 C 71.245 39.208 70.35 38.312 69.245 38.312 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg></button>
                <button type="button" id="stop-button" disabled><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="35" height="35" viewBox="0 0 256 256" xml:space="preserve">

                    <defs>
                    </defs>
                    <g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)" >
                        <path d="M 70.219 0.253 c -0.963 -0.538 -2.183 -0.191 -2.721 0.773 l -7.19 12.897 C 59.57 6.124 52.989 0 45 0 c -8.481 0 -15.382 6.9 -15.382 15.382 v 29.044 c 0 5.12 2.497 9.802 6.631 12.652 l -4.31 7.732 c -5.706 -4.159 -9.183 -10.873 -9.183 -17.992 v -6.505 c 0 -1.104 -0.896 -2 -2 -2 s -2 0.896 -2 2 v 6.505 c 0 8.562 4.257 16.632 11.221 21.513 L 19.553 87.026 c -0.538 0.965 -0.191 2.183 0.773 2.721 C 20.634 89.919 20.968 90 21.298 90 c 0.702 0 1.383 -0.37 1.749 -1.026 l 47.945 -86 C 71.53 2.009 71.184 0.791 70.219 0.253 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                        <path d="M 69.245 38.312 c -1.104 0 -2 0.896 -2 2 v 6.505 c 0 12.266 -9.979 22.244 -22.245 22.244 c -2.1 0 -4.178 -0.292 -6.176 -0.867 c -1.06 -0.308 -2.169 0.308 -2.475 1.368 c -0.306 1.062 0.307 2.17 1.369 2.476 c 1.721 0.495 3.491 0.808 5.283 0.943 V 86 h -9.126 c -1.104 0 -2 0.896 -2 2 s 0.896 2 2 2 h 22.252 c 1.104 0 2 -0.896 2 -2 s -0.896 -2 -2 -2 H 47 V 72.978 c 13.54 -1.026 24.245 -12.363 24.245 -26.16 v -6.505 C 71.245 39.208 70.35 38.312 69.245 38.312 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                        <path d="M 56.382 34.041 v 10.385 c 0 6.152 -5.002 11.256 -11.149 11.379 c -1.104 0.022 -1.981 0.936 -1.959 2.04 c 0.022 1.091 0.913 1.96 1.999 1.96 c 0.014 0 0.027 0 0.041 0 c 8.31 -0.167 15.069 -7.065 15.069 -15.379 V 34.041 c 0 -1.104 -0.896 -2 -2 -2 S 56.382 32.937 56.382 34.041 z" style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,0,0); fill-rule: nonzero; opacity: 1;" transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                    </g>
                    </svg></button>
                <input type="hidden" id="audio-data" name="audio" class="input-field">
                <div class="submit"><button type="submit" id="submit-button" style="margin-top:-54px; height:40px; width:80px; font-size:16px; background-color: #61c2ff ; color:white; " disabled>Analyze</button> </div>
            </form>
        </div>
        <br>
    
    </div>
    

<script>
    let mediaRecorder;
    let audioChunks = [];

    const recordButton = document.getElementById('record-button');
    const stopButton = document.getElementById('stop-button');
    const submitButton = document.getElementById('submit-button');
    const audioDataInput = document.getElementById('audio-data');
    const emotionText = document.getElementById('emotion-text');
    const playerContainer = document.getElementById('player-container');
    const spotifyPlayer = document.getElementById('spotify-player');

    //CHAT
    function appendMessage(text, sender, spotifyURL = null) {
        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");

        messageDiv.classList.add("chat-message", sender === "user" ? "user-message" : "bot-message");

        if (spotifyURL) {
            messageDiv.innerHTML = `
                <p>${text}</p>
                <iframe src="${spotifyURL}" width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
            `;
        } else {
            messageDiv.textContent = text;
        }

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll down
    }

    //initial message
    appendMessage("Hello, How are you feeling today?", "bot");

    // Start Recording
    recordButton.addEventListener('click', async () => 
    {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) 
        {
            try 
            {
                // request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                // store recorded audio data
                mediaRecorder.ondataavailable = event => 
                {
                    if (event.data.size > 0) 
                    {
                        audioChunks.push(event.data);
                    }
                };

                // process audio after stopping
                mediaRecorder.onstop = () => 
                {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const reader = new FileReader();

                    reader.onload = () => 
                    {
                        audioDataInput.value = reader.result; // convert audio to Base64
                        submitButton.disabled = false;
                    };

                    reader.readAsDataURL(audioBlob);
                    audioChunks = [];
                };

                mediaRecorder.start();
                recordButton.disabled = true;
                stopButton.disabled = false;
            } 
            catch (error) 
            {
                console.error('Error accessing microphone:', error);
            }
        } 
        else 
        {
            alert('Your browser does not support audio recording.');
        }
    });



    // Stop Recording
    stopButton.addEventListener('click', () => 
    {
        if (mediaRecorder) 
        {
            mediaRecorder.stop();
            recordButton.disabled = false;
            stopButton.disabled = true;
        }
    });



    // Submit Button (Change Name to "Analyze" in HTML don't change here)
    submitButton.addEventListener('click', async (e) => 
    {
        e.preventDefault();

        const audioBase64 = audioDataInput.value; //retrieve base64 audio data

        if (!audioBase64) 
        {
            alert("No audio data to send. Please record first."); //check if audio recorded
            return;
        }

        try 
        {
            submitButton.disabled = true;

            // user message that plays what was recorded
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user-message';
            
            // adds audio element (that thing that plays your audio)
            const audioElement = document.createElement('audio');
            audioElement.controls = true;
            audioElement.src = audioBase64;
            audioElement.classList.add('audio-player');
            
            // add to chat
            const label = document.createElement('p');
            userMessageDiv.appendChild(label);
            userMessageDiv.appendChild(audioElement);

            document.getElementById('chat-container').appendChild(userMessageDiv);

            // processing... message
            appendMessage("Processing...", "bot");

            // sends POST request with audio data
            const response = await fetch("http://127.0.0.1:5000/audio_input", 
            {
                method: "POST",
                headers: 
                {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({audio: audioBase64,}),
            });

            if (response.ok) 
            {
                const jsonResponse = await response.json();
                const detectedEmotion = jsonResponse.emotion; 
                emotionText.textContent = detectedEmotion;

                // add detected emotion:?? to chat
                appendMessage(`Detected Emotion: ${detectedEmotion}`, "bot");
            } 
            else 
            {
                console.error("Failed to fetch emotion:", response.statusText);
                emotionText.textContent = "Error detecting emotion.";
                appendMessage("Error detecting emotion.", "bot");
            }

            // get song uri from backend
            const songResponse = await fetch("http://127.0.0.1:5000/get_playlist");
            const songData = await songResponse.json();


            // plays the song in spotify player
            if (songData.uri && songData.uri.startsWith("spotify:track:")) {
                const trackId = songData.uri.split(':').pop();
                console.log(`Playing song: ${trackId}`); 
                document.getElementById("spotify-player").src = `https://open.spotify.com/embed/track/${trackId}`;
                document.getElementById("player-container").style.display = "block";
                 // Append song message
                // appendMessage(`Now Playing:`, "bot", spotifyEmbedURL);
            } else {
                throw new Error("Invalid song URI received");
                 // Append song message
                // appendMessage(`Now Playing:`, "bot", spotifyEmbedURL);
            }

        } catch (error) {
            // appendMessage(`Error: ${error.message}`, "bot");
            console.error("Error:", error);
            document.getElementById("emotion-text").textContent = error.message;
            
        } finally {
            submitButton.disabled = false;
        }
    });
</script>
</body>
</html>